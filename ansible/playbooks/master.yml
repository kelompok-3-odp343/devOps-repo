---
- name: Setup K3s Master and ArgoCD
  hosts: master
  become: yes
  vars:
    k3s_install_script: https://get.k3s.io
    argocd_namespace: argocd
    argocd_manifest_url: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    repo_url: https://github.com/kelompok-3-odp343/infra.git
    repo_dir: /home/infra
    nginx_ingress_manifest: "https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml"

  tasks:
    # ==========================
    # 1Ô∏è‚É£ Install basic dependencies
    # ==========================
    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - git
        state: present
        update_cache: yes

    # ==========================
    # 2Ô∏è‚É£ Install / Reinstall K3s (disable Traefik)
    # ==========================
    - name: Checking k3s service
      stat:
        path: /etc/systemd/system/k3s.service
      register: k3s_service

    - name: Stop k3s if exist
      when: k3s_service.stat.exists
      block:
        - name: Stop k3s service
          systemd:
            name: k3s
            state: stopped
            enabled: no

        - name: Remove k3s binary dan service file
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /usr/local/bin/k3s
            - /etc/systemd/system/k3s.service

        - name: Reload systemd daemon
          command: systemctl daemon-reload

    - name: Install K3s master without Traefik
      shell: |
        curl -sfL {{ k3s_install_script }} | sh -s - server --cluster-init --disable=traefik --flannel-backend=vxlan
      args:
        creates: /etc/systemd/system/k3s.service

    - name: Ensure K3s service is enabled and running
      systemd:
        name: k3s
        enabled: yes
        state: started

    # ==========================
    # 3Ô∏è‚É£ Wait for K3s Ready
    # ==========================
    - name: Wait for K3s to be ready
      shell: sudo kubectl get nodes
      register: k3s_nodes
      until: '"Ready" in k3s_nodes.stdout'
      retries: 10
      delay: 10

    - name: Deploy NGINX Ingress Controller
      shell: kubectl apply -f {{ nginx_ingress_manifest }}

    - name: Wait for ingress-nginx namespace to exist
      shell: kubectl get ns ingress-nginx
      register: ns_check
      until: ns_check.rc == 0
      retries: 10
      delay: 5

    - name: Wait for NGINX ingress controller pods
      shell: kubectl get pods -n ingress-nginx --selector=app.kubernetes.io/name=ingress-nginx --no-headers
      register: nginx_pods
      until: nginx_pods.stdout != ""
      retries: 15
      delay: 10

    - name: Wait NGINX ingress controller Ready
      shell: kubectl wait --namespace ingress-nginx --for=condition=Ready pods --selector=app.kubernetes.io/name=ingress-nginx --timeout=180s

    # ==========================
    # 5Ô∏è‚É£ Install ArgoCD
    # ==========================
    - name: Create namespace for ArgoCD
      shell: sudo kubectl create namespace {{ argocd_namespace }} || true

    - name: Deploy ArgoCD manifests
      shell: sudo kubectl apply -n {{ argocd_namespace }} -f {{ argocd_manifest_url }}

    # ==========================
    # 6Ô∏è‚É£ Wait for ArgoCD Pods Running
    # ==========================
    - name: Wait for ArgoCD pods to be ready
      shell: sudo kubectl get pods -n {{ argocd_namespace }} --no-headers
      register: argocd_pods
      until: "'Running' in argocd_pods.stdout"
      retries: 20
      delay: 15

    # ==========================
    # 7Ô∏è‚É£ Show ArgoCD Admin Password
    # ==========================
    - name: Get ArgoCD admin password
      shell: sudo kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode
      register: argocd_password

    - name: Show ArgoCD admin password
      debug:
        msg: "üîê ArgoCD admin password: {{ argocd_password.stdout }}"

    # ==========================
    # 8Ô∏è‚É£ Patch ArgoCD Service -> NodePort
    # ==========================
    - name: Patch ArgoCD server service to NodePort
      shell: |
        sudo kubectl -n {{ argocd_namespace }} patch svc argocd-server -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "nodePort": 31453}]}}'

    # ==========================
    # 9Ô∏è‚É£ Apply Project Manifests (frontend, backend, monitoring)
    # ==========================
    - name: Apply namespace manifests
      shell: sudo kubectl apply -f {{ repo_dir }}/k3s-manifests/namespace.yaml

    - name: Apply namespace manifests
      shell: sudo kubectl apply -f {{ repo_dir }}/monitoring-wandoor/monitoring-namespace.yaml

    - name: Apply frontend
      shell: sudo kubectl apply -f {{ repo_dir }}/k3s-manifests/frontend-wandoor/

    - name: Apply backend
      shell: sudo kubectl apply -f {{ repo_dir }}/k3s-manifests/backend-wandoor/

    - name: Apply lgtm-agents
      shell: sudo kubectl apply -f {{ repo_dir }}/monitoring-wandoor/vm-master/

    - name: Apply ArgoCD application manifests
      shell: sudo kubectl apply -f {{ repo_dir }}/argoCD/
