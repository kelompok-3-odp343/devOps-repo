---
- name: üß© Setup K3s Worker Nodes
  hosts: worker
  become: yes
  vars:
    master_ip: "{{ hostvars['master'].ansible_host }}"
    k3s_token_path: "/var/lib/rancher/k3s/server/node-token"
    k3s_url: "https://{{ master_ip }}:6443"
    ssh_user: "your-ssh-user" # ganti sesuai user SSH ke master
    ssh_private_key: "/home/{{ ansible_user }}/.ssh/id_rsa" # path key privat jika pakai key
    local_socks_port: 1080
    local_forward_port: 3128

  tasks:
    # ==========================
    # 0Ô∏è‚É£ Buat SSH Dynamic SOCKS Proxy
    # ==========================
    - name: Start SSH dynamic SOCKS proxy to master
      shell: |
        nohup ssh -i {{ ssh_private_key }} -D {{ local_socks_port }} -q -C -N {{ ssh_user }}@{{ master_ip }} > /tmp/ssh_socks.log 2>&1 &
      args:
        executable: /bin/bash

    # ==========================
    # 0Ô∏è‚É£ Buat SSH Local Port Forward
    # ==========================
    - name: Start SSH local port forwarding to master (3128)
      shell: |
        nohup ssh -i {{ ssh_private_key }} -L {{ local_forward_port }}:localhost:3128 -q -N {{ ssh_user }}@{{ master_ip }} > /tmp/ssh_forward.log 2>&1 &
      args:
        executable: /bin/bash

    # ==========================
    # 1Ô∏è‚É£ Pastikan dependency dasar terinstall via proxy
    # ==========================
    - name: Install basic dependencies
      apt:
        name:
          - curl
          - wget
          - git
        state: present
        update_cache: yes
      environment:
        DEBIAN_FRONTEND: noninteractive
        http_proxy: "http://127.0.0.1:{{ local_forward_port }}"
        https_proxy: "http://127.0.0.1:{{ local_forward_port }}"

    # ==========================
    # 2Ô∏è‚É£ Ambil token dari master node
    # ==========================
    - name: Fetch K3s join token from master
      delegate_to: master
      become: yes
      slurp:
        src: "{{ k3s_token_path }}"
      register: master_token_raw

    - name: Decode token dari master
      set_fact:
        k3s_token: "{{ master_token_raw.content | b64decode | trim }}"

    # ==========================
    # 3Ô∏è‚É£ Join worker ke cluster master
    # ==========================
    - name: Join worker ke K3s cluster
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL={{ k3s_url }} K3S_TOKEN={{ k3s_token }} sh -
      args:
        creates: /etc/systemd/system/k3s-agent.service
      register: join_result

    - name: Tampilkan hasil join
      debug:
        var: join_result.stdout

    # ==========================
    # 4Ô∏è‚É£ Pastikan service aktif
    # ==========================
    - name: Enable and start k3s-agent service
      systemd:
        name: k3s-agent
        enabled: yes
        state: started

    # ==========================
    # 5Ô∏è‚É£ Verifikasi koneksi ke master
    # ==========================
    - name: Verifikasi koneksi worker ke master
      shell: |
        kubectl get nodes
      delegate_to: master
      register: nodes_status
      ignore_errors: yes

    - name: Tampilkan hasil verifikasi
      debug:
        var: nodes_status.stdout
